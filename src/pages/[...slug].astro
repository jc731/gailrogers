---
import BaseLayout from '../layouts/BaseLayout.astro';
import SectionRenderer from '../components/SectionRenderer.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const pages = await getCollection('pages');
  const practiceAreas = await getCollection('practiceAreas');

  const paths: Array<{ params: { slug: string }; props: any }> = [];

  // Regular pages (excluding home, which is handled by index.astro)
  for (const page of pages) {
    const pageSlug = page.data.slug || page.id.replace(/\.mdx?$/, '');
    if (pageSlug !== 'home') {
      paths.push({
        params: { slug: pageSlug },
        props: {
          page,
          type: 'page',
        },
      });
    }
  }

  // Practice areas
  for (const practiceArea of practiceAreas) {
    const areaSlug = practiceArea.data.slug || practiceArea.id.replace(/\.mdx?$/, '');
    paths.push({
      params: { slug: `practice/${areaSlug}` },
      props: {
        page: practiceArea,
        type: 'practiceArea',
      },
    });
  }

  return paths;
}

interface Props {
  page: any;
  type: 'page' | 'practiceArea';
}

const { page, type } = Astro.props;
const { Content } = await page.render();

const title = page.data.seoTitle || page.data.title;
const description = page.data.seoDescription || '';

// Check if this is the contact page
const isContactPage = page.data.slug === 'contact' || page.id.replace(/\.mdx?$/, '') === 'contact';

// For contact page, find contactForm and richText sections for 2-column layout
let contactFormSection: any = null;
let officeLocationSection: any = null;
let otherSections: any[] = [];

if (isContactPage) {
  for (const section of page.data.sections) {
    if (section.type === 'contactForm') {
      contactFormSection = section;
    } else if (section.type === 'richText' && section.content?.includes('Office Location')) {
      officeLocationSection = section;
    } else {
      otherSections.push(section);
    }
  }
}
---

<BaseLayout title={title} description={description}>
  {isContactPage && contactFormSection && officeLocationSection ? (
    <>
      {/* Render other sections (hero, ctaBand, etc.) */}
      {otherSections.map((section: any) => (
        <SectionRenderer section={section} />
      ))}
      
      {/* 2-column layout for contact form and office location on lg+ screens */}
      <div class="container mx-auto max-w-7xl px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
          <div class="lg:sticky lg:top-8 lg:self-start">
            <SectionRenderer section={contactFormSection} />
          </div>
          <div class="py-8 lg:py-0">
            <SectionRenderer section={officeLocationSection} />
          </div>
        </div>
      </div>
    </>
  ) : (
    <>
      {page.data.sections.map((section: any) => (
        <SectionRenderer section={section} />
      ))}
    </>
  )}
  
  {/* Render MDX content if present */}
  {Content && (
    <div class="container mx-auto max-w-4xl px-4 py-8">
      <Content />
    </div>
  )}

  {/* Add FAQ section if practice area has FAQs */}
  {type === 'practiceArea' && page.data.faqs && page.data.faqs.length > 0 && (
    <SectionRenderer 
      section={{
        type: 'faq',
        title: 'Frequently Asked Questions',
        items: page.data.faqs,
      }}
    />
  )}
</BaseLayout>

