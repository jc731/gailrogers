---
import Button from '../Button.astro';

interface Props {
  slides: Array<{
    heading: string;
    subheading?: string;
    image: string;
    ctaText?: string;
    ctaLink?: string;
    alt?: string;
  }>;
  autoplay?: boolean;
  autoplayInterval?: number;
  showIndicators?: boolean;
  showControls?: boolean;
}

const {
  slides,
  autoplay = true,
  autoplayInterval = 6250,
  showIndicators = true,
  showControls = true,
} = Astro.props;

const sliderId = `slider-${Math.random().toString(36).substring(7)}`;
---

<section class="relative w-full" data-slider-id={sliderId} tabindex="0">
  <div class="relative overflow-hidden">
    <div
      class="slider-container"
      role="region"
      aria-label="Image carousel"
      tabindex="0"
    >
      {
        slides.map((slide, index) => (
          <div
            class={`slide ${index === 0 ? "active" : ""}`}
            data-slide-index={index}
            aria-hidden={index !== 0}
          >
            <div class="relative bg-gradient-to-r from-brand-primary to-brand-primaryDark text-white">
              <img
                src={slide.image}
                alt={slide.alt || slide.heading}
                class="w-full h-[400px] sm:h-[500px] md:h-[600px] object-cover"
                loading={index === 0 ? "eager" : "lazy"}
              />
              <div class="absolute inset-0 bg-brand-primaryDark/70" />
              <div class="absolute inset-0 flex items-center justify-center">
                <div class="container mx-auto px-14 md:px-6 lg:px-8 text-center relative z-10">
                  <h1 class="text-2xl sm:text-3xl md:text-4xl lg:text-5xl xl:text-6xl font-bold mb-4 break-words">
                    {slide.heading}
                  </h1>
                  {slide.subheading && (
                    <p class="text-base sm:text-lg md:text-xl lg:text-2xl xl:text-3xl mb-8 break-words">
                      {slide.subheading}
                    </p>
                  )}
                  {slide.ctaText && slide.ctaLink && (
                    <Button href={slide.ctaLink} variant="white">
                      {slide.ctaText}
                    </Button>
                  )}
                </div>
              </div>
            </div>
          </div>
        ))
      }
    </div>

    {
      showControls && slides.length > 1 && (
        <>
          {/* Mobile: Full-height edge buttons */}
          <button
            class="slider-prev absolute left-0 top-0 bottom-0 w-12 md:hidden bg-black/20 hover:bg-black/30 text-white flex items-center justify-center transition-colors z-20 rounded-r"
            aria-label="Previous slide"
            data-slider-prev
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 19l-7-7 7-7"
              />
            </svg>
          </button>
          <button
            class="slider-next absolute right-0 top-0 bottom-0 w-12 md:hidden bg-black/20 hover:bg-black/30 text-white flex items-center justify-center transition-colors z-20 rounded-l"
            aria-label="Next slide"
            data-slider-next
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5l7 7-7 7"
              />
            </svg>
          </button>

          {/* Desktop: Circular buttons */}
          <button
            class="slider-prev hidden md:flex absolute left-4 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white text-brand-primary p-3 rounded-full focus-ring min-h-[44px] min-w-[44px] items-center justify-center transition-colors z-20"
            aria-label="Previous slide"
            data-slider-prev
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 19l-7-7 7-7"
              />
            </svg>
          </button>
          <button
            class="slider-next hidden md:flex absolute right-4 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white text-brand-primary p-3 rounded-full focus-ring min-h-[44px] min-w-[44px] items-center justify-center transition-colors z-20"
            aria-label="Next slide"
            data-slider-next
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5l7 7-7 7"
              />
            </svg>
          </button>
        </>
      )
    }

    {
      showIndicators && slides.length > 1 && (
        <div
          class="hidden md:flex absolute bottom-4 left-1/2 -translate-x-1/2 gap-2 z-20"
          role="tablist"
          aria-label="Slide indicators"
        >
          {slides.map((_, index) => (
            <button
              class={`slider-indicator w-3 h-3 rounded-full transition-all focus-ring p-2 flex items-center justify-center ${
                index === 0 ? "bg-white" : "bg-white/50"
              }`}
              aria-label={`Go to slide ${index + 1}`}
              data-slide-to={index}
              role="tab"
              aria-selected={index === 0}
            />
          ))}
        </div>
      )
    }
  </div>
</section>

<style>
  .slider-container {
    position: relative;
    outline: none;
    min-height: 400px;
  }

  @media (min-width: 640px) {
    .slider-container {
      min-height: 500px;
    }
  }

  @media (min-width: 768px) {
    .slider-container {
      min-height: 600px;
    }
  }

  /* Custom focus styles for mobile slider buttons - gold border to match branding */
  @media (max-width: 767px) {
    .slider-prev:focus-visible {
      outline: none;
      box-shadow: inset -2px 0 0 0 #a88b4a;
    }

    .slider-next:focus-visible {
      outline: none;
      box-shadow: inset 2px 0 0 0 #a88b4a;
    }
  }

  .slide {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    opacity: 0;
    transition: opacity 0.5s ease-in-out;
    pointer-events: none;
  }

  .slide.active {
    opacity: 1;
    pointer-events: auto;
  }

  @media (prefers-reduced-motion: reduce) {
    .slide {
      transition: none;
    }
  }
</style>

<script is:inline define:vars={{ sliderId, autoplay, autoplayInterval }}>
  const slider = document.querySelector(`[data-slider-id="${sliderId}"]`);
  if (!slider) return;

  const container = slider.querySelector(".slider-container");
  const slideElements = container.querySelectorAll(".slide");
  const prevBtns = slider.querySelectorAll("[data-slider-prev]");
  const nextBtns = slider.querySelectorAll("[data-slider-next]");
  const indicators = slider.querySelectorAll(".slider-indicator");

  let currentSlide = 0;
  let autoplayTimer = null;

  function showSlide(index) {
    // Helper function to find all focusable elements within a slide
    function getFocusableElements(container) {
      const focusableSelectors = [
        'a[href]',
        'button:not([disabled])',
        'input:not([disabled])',
        'select:not([disabled])',
        'textarea:not([disabled])',
        '[tabindex]:not([tabindex="-1"])'
      ].join(', ');
      return container.querySelectorAll(focusableSelectors);
    }

    // Update all slides - use opacity for cross-fade effect
    slideElements.forEach((slide, i) => {
      const focusableElements = getFocusableElements(slide);
      
      if (i === index) {
        // Activate current slide
        slide.classList.add("active");
        slide.setAttribute("aria-hidden", "false");
        
        // Make focusable elements in active slide focusable
        focusableElements.forEach((element) => {
          // Remove tabindex if it was set to -1, or remove the attribute entirely
          if (element.hasAttribute('tabindex') && element.getAttribute('tabindex') === '-1') {
            element.removeAttribute('tabindex');
          }
        });
      } else {
        // Deactivate other slides
        slide.classList.remove("active");
        slide.setAttribute("aria-hidden", "true");
        
        // Make focusable elements in hidden slide unfocusable
        focusableElements.forEach((element) => {
          element.setAttribute('tabindex', '-1');
        });
      }

      // Update indicators
      if (indicators[i]) {
        if (i === index) {
          indicators[i].classList.remove("bg-white/50");
          indicators[i].classList.add("bg-white");
          indicators[i].setAttribute("aria-selected", "true");
        } else {
          indicators[i].classList.remove("bg-white");
          indicators[i].classList.add("bg-white/50");
          indicators[i].setAttribute("aria-selected", "false");
        }
      }
    });

    currentSlide = index;
  }

  function nextSlide() {
    const next = (currentSlide + 1) % slideElements.length;
    showSlide(next);
  }

  function prevSlide() {
    const prev =
      (currentSlide - 1 + slideElements.length) % slideElements.length;
    showSlide(prev);
  }

  function startAutoplay() {
    if (autoplay && slideElements.length > 1) {
      autoplayTimer = setInterval(nextSlide, autoplayInterval);
    }
  }

  function stopAutoplay() {
    if (autoplayTimer) {
      clearInterval(autoplayTimer);
      autoplayTimer = null;
    }
  }

  // Event listeners - handle both mobile and desktop buttons
  nextBtns.forEach((btn) => {
    btn.addEventListener("click", () => {
      stopAutoplay();
      nextSlide();
      startAutoplay();
    });
  });

  prevBtns.forEach((btn) => {
    btn.addEventListener("click", () => {
      stopAutoplay();
      prevSlide();
      startAutoplay();
    });
  });

  indicators.forEach((indicator, index) => {
    indicator.addEventListener("click", () => {
      stopAutoplay();
      showSlide(index);
      startAutoplay();
    });
  });

  // Pause autoplay on hover
  slider.addEventListener("mouseenter", stopAutoplay);
  slider.addEventListener("mouseleave", startAutoplay);

  // Keyboard navigation - only when slider is focused
  slider.addEventListener(
    "keydown",
    function (e) {
      // Only handle if slider container is focused (not a child element)
      if (
        document.activeElement === slider ||
        container.contains(document.activeElement)
      ) {
        if (e.key === "ArrowLeft") {
          e.preventDefault();
          stopAutoplay();
          prevSlide();
          startAutoplay();
        } else if (e.key === "ArrowRight") {
          e.preventDefault();
          stopAutoplay();
          nextSlide();
          startAutoplay();
        } else if (e.key === "Home") {
          e.preventDefault();
          stopAutoplay();
          showSlide(0);
          startAutoplay();
        } else if (e.key === "End") {
          e.preventDefault();
          stopAutoplay();
          showSlide(slideElements.length - 1);
          startAutoplay();
        }
      }
    }.bind(slider)
  );

  // Initialize slide states (ensures tabindex is set correctly for all slides)
  showSlide(0);

  // Start autoplay
  startAutoplay();

  // Cleanup on component unmount
  document.addEventListener("astro:before-swap", () => {
    stopAutoplay();
  });
</script>
