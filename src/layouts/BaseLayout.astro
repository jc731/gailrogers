---
import "../styles/global.css";
import { getCollection, type CollectionEntry } from "astro:content";
import Logo from "../components/Logo.astro";
import DropdownIndicator from "../components/DropdownIndicator.astro";
import MobileMenu from "../components/MobileMenu.astro";
// import BreakpointIndicator from '../components/BreakpointIndicator.astro';
import { getSiteSettings } from "../utils/content";

interface Props {
  title: string;
  description?: string;
  currentPath?: string;
}

const { title, description, currentPath = "" } = Astro.props;

// Load site settings (cached by Astro during build)
const siteEntries = await getCollection("site");
const siteSettings = getSiteSettings(siteEntries);

const siteTitle = siteSettings?.brandName || "Site";
const primaryPhone = siteSettings?.primaryPhone || "";
const phones = siteSettings?.phones || [];
const address = siteSettings?.address;
const hours = siteSettings?.hours || "";
const legalDisclaimer = siteSettings?.legalDisclaimer || "";
const navigation = siteSettings?.navigation || [];
const footerNavigation = siteSettings?.footerNavigation || [];
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description || ""} />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Favicons -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="manifest" href="/site.webmanifest" />
    <link rel="sitemap" type="application/xml" href="/sitemap-index.xml" />

    <meta name="generator" content={Astro.generator} />
    <title>{title} | {siteTitle}</title>
  </head>
  <body>
    {/* <BreakpointIndicator /> */}
    <a
      href="#main-content"
      class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:px-4 focus:py-2 focus:py-3 focus:bg-brand-primary focus:text-white focus:rounded focus:font-semibold focus:shadow-lg focus-ring-dark min-h-[44px]"
    >
      Skip to content
    </a>

    <header class="bg-white shadow-md">
      <nav class="container mx-auto px-4 py-4">
        <div class="flex justify-between items-center">
          <Logo brandName="ROGERS" tagline="LAW OFFICE" href="/" />
          <div class="flex gap-6 items-center">
            {/* Desktop Navigation */}
            <div class="hidden md:flex gap-6 items-center">
              {
                navigation.map((item, index) => {
                  const menuId = `menu-${index}`;
                  const buttonId = `menu-button-${index}`;
                  const isParentActive =
                    currentPath === item.href ||
                    (item.children &&
                      item.children.some(
                        (child) => currentPath === child.href
                      ));
                  const linkClasses = isParentActive
                    ? "text-brand-primary font-semibold hover:text-brand-primary focus-ring px-2 py-1 rounded min-h-[44px] flex items-center"
                    : "text-gray-700 hover:text-brand-primary focus-ring px-2 py-1 rounded min-h-[44px] flex items-center";

                  return (
                    <div class="relative group" data-nav-item={index}>
                      {item.children && item.children.length > 0 ? (
                        <>
                          <div class="flex items-center gap-1">
                            <a
                              href={item.href}
                              id={buttonId}
                              aria-haspopup="true"
                              aria-controls={menuId}
                              class={linkClasses}
                              data-nav-link={index}
                            >
                              {item.label}
                            </a>
                            <span
                              class="pointer-events-none"
                              aria-hidden="true"
                            >
                              <DropdownIndicator
                                size="sm"
                                className="text-current"
                              />
                            </span>
                          </div>
                          <div
                            id={menuId}
                            role="menu"
                            aria-labelledby={buttonId}
                            class="absolute left-0 top-full mt-1 w-64 bg-white shadow-lg rounded-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible group-focus-within:opacity-100 group-focus-within:visible transition-all duration-200 z-50"
                            data-nav-menu={index}
                          >
                            <ul class="py-2">
                              {item.children.map((child, childIndex) => {
                                const isChildActive =
                                  currentPath === child.href;
                                const childClasses = isChildActive
                                  ? "block px-4 py-2 text-brand-primary font-semibold bg-brand-light focus-ring rounded mx-2 min-h-[44px] flex items-center"
                                  : "block px-4 py-2 text-gray-700 hover:bg-brand-light hover:text-brand-primary focus-ring rounded mx-2 min-h-[44px] flex items-center";

                                return (
                                  <li role="none">
                                    <a
                                      href={child.href}
                                      role="menuitem"
                                      class={childClasses}
                                      data-nav-child={`${index}-${childIndex}`}
                                    >
                                      {child.label}
                                    </a>
                                  </li>
                                );
                              })}
                            </ul>
                          </div>
                        </>
                      ) : (
                        <a
                          href={item.href}
                          class={
                            currentPath === item.href
                              ? "text-brand-primary font-semibold hover:text-brand-primary focus-ring px-2 py-1 rounded min-h-[44px] flex items-center"
                              : "text-gray-700 hover:text-brand-primary focus-ring px-2 py-1 rounded min-h-[44px] flex items-center"
                          }
                        >
                          {item.label}
                        </a>
                      )}
                    </div>
                  );
                })
              }
              {
                primaryPhone && (
                  <a
                    href={`tel:${primaryPhone}`}
                    class="text-brand-primary font-semibold focus-ring px-2 py-1 rounded min-h-[44px] flex items-center"
                  >
                    {primaryPhone}
                  </a>
                )
              }
            </div>

            {/* Mobile Menu Button */}
            <MobileMenu
              navigation={navigation}
              primaryPhone={primaryPhone}
              currentPath={currentPath}
            />
          </div>

          <script>
            // Keyboard navigation for dropdown menus (hover-based, so minimal JS needed)
            // Dropdowns are shown via CSS :hover, this script handles keyboard navigation within menus
            document.addEventListener("DOMContentLoaded", () => {
              const navLinks = document.querySelectorAll("[data-nav-link]");

              navLinks.forEach((link) => {
                const linkIndex = link.getAttribute("data-nav-link");
                const menu = document.querySelector(
                  `[data-nav-menu="${linkIndex}"]`
                );
                const menuItems = menu?.querySelectorAll("[data-nav-child]");

                if (!menu || !menuItems) return;

                // Keyboard navigation: ArrowDown opens menu and focuses first item
                link.addEventListener("keydown", (e) => {
                  if (e.key === "ArrowDown") {
                    e.preventDefault();
                    link.setAttribute("aria-expanded", "true");
                    menu.classList.remove("opacity-0", "invisible");
                    if (menuItems.length > 0) {
                      (menuItems[0] as HTMLElement).focus();
                    }
                  }
                });

                // Keyboard navigation within menu
                menuItems.forEach((item, index) => {
                  item.addEventListener("keydown", (e) => {
                    if (e.key === "ArrowDown") {
                      e.preventDefault();
                      const next =
                        index < menuItems.length - 1
                          ? menuItems[index + 1]
                          : menuItems[0];
                      (next as HTMLElement).focus();
                    } else if (e.key === "ArrowUp") {
                      e.preventDefault();
                      const prev =
                        index > 0
                          ? menuItems[index - 1]
                          : menuItems[menuItems.length - 1];
                      (prev as HTMLElement).focus();
                    } else if (e.key === "Escape") {
                      e.preventDefault();
                      link.setAttribute("aria-expanded", "false");
                      menu.classList.add("opacity-0", "invisible");
                      (link as HTMLElement).focus();
                    }
                  });
                });

                // Close menu when focus leaves
                const navItem = link.closest("[data-nav-item]");
                navItem?.addEventListener("focusout", (e) => {
                  // Only close if focus is moving outside the menu
                  setTimeout(() => {
                    if (!navItem?.contains(document.activeElement)) {
                      link.setAttribute("aria-expanded", "false");
                      menu.classList.add("opacity-0", "invisible");
                    }
                  }, 100);
                });
              });
            });
          </script>
        </div>
      </nav>
    </header>

    <main id="main-content">
      <slot />
    </main>

    <footer
      class="bg-brand-primaryDark text-white py-8 px-4 md:px-6 lg:px-8 mt-16"
    >
      <div class="container mx-auto max-w-6xl">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
          <div>
            <h3 class="text-xl font-bold mb-4">Office Location</h3>
            {
              address && (
                <div class="text-white">
                  <p class="font-semibold mb-2">{siteTitle}</p>
                  <p class="mb-2">
                    {address.street}
                    <br />
                    {address.city}, {address.state} {address.zip}
                  </p>
                  {hours && <p class="text-sm mt-3 opacity-90">{hours}</p>}
                </div>
              )
            }
          </div>
          <div>
            <h3 class="text-xl font-bold mb-4">Contact</h3>
            <div class="text-white space-y-2">
              {
                phones.length > 0 &&
                  phones.map((phone) => (
                    <p>
                      {phone === primaryPhone ? (
                        <>
                          <span class="font-semibold">
                            Call For Consultation:
                          </span>
                          <br />
                          <a
                            href={`tel:${phone}`}
                            class="hover:underline focus-ring-dark transition-colors"
                          >
                            {phone}
                          </a>
                        </>
                      ) : (
                        <>
                          <span class="font-semibold">Phone:</span>
                          <br />
                          <a
                            href={`tel:${phone}`}
                            class="hover:underline focus-ring-dark transition-colors"
                          >
                            {phone}
                          </a>
                        </>
                      )}
                    </p>
                  ))
              }
            </div>
          </div>
          <div>
            <h3 class="text-xl font-bold mb-4">Quick Links</h3>
            <ul class="space-y-2 text-white">
              {
                navigation.map((item) => {
                  // Skip items with children (like Practice Areas dropdown) - just show the main link
                  if (item.children && item.children.length > 0) {
                    return (
                      <li>
                        <a
                          href={item.href}
                          class="hover:underline focus-ring-dark transition-colors"
                        >
                          {item.label}
                        </a>
                      </li>
                    );
                  }
                  return (
                    <li>
                      <a
                        href={item.href}
                        class="hover:underline focus-ring-dark transition-colors"
                      >
                        {item.label}
                      </a>
                    </li>
                  );
                })
              }
              {
                footerNavigation.map((item) => (
                  <li>
                    <a
                      href={item.href}
                      class="hover:underline focus-ring-dark transition-colors"
                    >
                      {item.label}
                    </a>
                  </li>
                ))
              }
            </ul>
          </div>
        </div>
        <div class="border-t border-brand-primaryDark pt-8">
          <p class="text-base sm:text-sm text-white opacity-90 break-words">
            {legalDisclaimer}
          </p>
        </div>
      </div>
    </footer>
  </body>
</html>
